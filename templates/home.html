<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/data.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://code.highcharts.com/modules/windbarb.js"></script>
    <script src="https://code.highcharts.com/modules/pattern-fill.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/charts.js') }}"></script>

    <title>Weather Application</title>
</head>
<body>
    <div class="weather-card">
        <div class="weather-card-title">
            <h2 style="color: #5e5e5e; font-size: 1.3em;">Weather Search</h2>
            <h3 style="color: #5e5e5e; font-size: 0.9em; font-weight: 500; margin-top: 15px;">Fill out the form to get weather info !</h3>
        </div>
        <div class="weather-card-form">
            <form onsubmit="return getWeatherInfo()" id="myForm">
                <label for="street" class="required formFont" style="color:#486cac">Street</label>
                <br>
                <input type="text" id="street" name="street" placeholder="Enter Street" required size="63" style="color: grey; border: 1px solid #e8e8eb; max-width: 91.5%;">
                <br>
                <div class="weather-card-form-address weather-card-form-padding-in-between">
                    <div>
                        <label for="city" class="required formFont" style="color:#486cac">City</label>
                        <br>
                        <input type="text" id="city" name="city" placeholder="Enter City" required size="25" style="color: grey; border: 1px solid #e8e8eb;">
                    </div>
                    <div>
                        <label for="state" class="required formFont" style="color:#486cac">State</label>
                        <br>
                        <select required name="state" id="state" style="color: grey;border: 1px solid #e8e8eb;">
                            <option disabled selected value style="color: grey;"> Select State</option>
                            <option value="AL">Alabama</option>
                            <option value="AK">Alaska</option>
                            <option value="AZ">Arizona</option>
                            <option value="AR">Arkansas</option>
                            <option value="CA">California</option>
                            <option value="CO">Colorado</option>
                            <option value="CT">Connecticut</option>
                            <option value="DE">Delaware</option>
                            <option value="DC">District Of Columbia</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="HI">Hawaii</option>
                            <option value="ID">Idaho</option>
                            <option value="IL">Illinois</option>
                            <option value="IN">Indiana</option>
                            <option value="IA">Iowa</option>
                            <option value="KS">Kansas</option>
                            <option value="KY">Kentucky</option>
                            <option value="LA">Louisiana</option>
                            <option value="ME">Maine</option>
                            <option value="MD">Maryland</option>
                            <option value="MA">Massachusetts</option>
                            <option value="MI">Michigan</option>
                            <option value="MN">Minnesota</option>
                            <option value="MS">Mississippi</option>
                            <option value="MO">Missouri</option>
                            <option value="MT">Montana</option>
                            <option value="NE">Nebraska</option>
                            <option value="NV">Nevada</option>
                            <option value="NH">New Hampshire</option>
                            <option value="NJ">New Jersey</option>
                            <option value="NM">New Mexico</option>
                            <option value="NY">New York</option>
                            <option value="NC">North Carolina</option>
                            <option value="ND">North Dakota</option>
                            <option value="OH">Ohio</option>
                            <option value="OK">Oklahoma</option>
                            <option value="OR">Oregon</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="RI">Rhode Island</option>
                            <option value="SC">South Carolina</option>
                            <option value="SD">South Dakota</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="UT">Utah</option>
                            <option value="VT">Vermont</option>
                            <option value="VA">Virginia</option>
                            <option value="WA">Washington</option>
                            <option value="WV">West Virginia</option>
                            <option value="WI">Wisconsin</option>
                            <option value="WY">Wyoming</option>
                        </select>
                    </div>
                </div>
                <hr style="margin-top: 5%;margin-bottom: 5%;border-color:rgb(31 84 213);">
                <div style="display:flex">
                    <span style="color:#486cac; font-size: 0.88em;">Want us to auto-detect your location? Check here</span>
                    <input type="checkbox" id="location" value="location" name="location">
                </div>
                <div class="weather-card-form-padding-in-between">
                    <button type="submit" style="background-color: #486cac; color: white;height: 35px;border: 0px; box-shadow: 0px 3px 0px #334b78; padding: 12px; font-size: 0.7em;font-weight: lighter;">SUBMIT</button>
                    <button id="form-clear" style="background-color: #fdb80f; color: white;height: 35px;border: 0px; box-shadow: 0px 3px 0px #e18a40; padding: 12px; font-size: 0.7em;font-weight: lighter;">CLEAR</button>
                </div>
            </form>
        </div>
    </div>

    <span id="errorMsg" style="display: none; margin-left: auto;margin-right: auto;margin-top: 10vh;">No Data Found !</span>

    <div class="card" id="cardDetails"></div>

    <div id="cardDetailsForecast" style="display:flex;justify-content: center;"></div>

    <div id="currentWeatherData"></div>

    <div id="charts" style="display: none;">
        <figure class="highcharts-figure">
            <div id="container"></div>
        </figure>

        <figure class="highcharts-figure">
            <div id="meteogram-container"></div>
        </figure>
    </div>

</body>
<script>

// base_url = "https://tomorrow-weather-328306.wn.r.appspot.com/"
base_url = "http://localhost:5000/"

// reset form fields => clear form fields. 
    var clear_button = document.getElementById("form-clear");
    clear_button.onclick = function(){

        errormsg = document.getElementById("errorMsg");
        errormsg.style.display = "none"

        var form = document.getElementById("myForm");
        
        var checkbox = document.querySelector("input[name=location]");
        if(checkbox.checked == true){
            document.getElementById("street").disabled = false;
            document.getElementById("city").disabled = false;
            document.getElementById("state").disabled = false;   
        }

        form.reset();

        component = document.getElementById("cardDetails");
        if(component.childNodes.length > 0){
            component.childNodes[0].remove();
        }

        component = document.getElementById("cardDetailsForecast");
        if(component.childNodes.length > 0){
            component.childNodes[0].remove();
        }

        component = document.getElementById("currentWeatherData");
        if(component.childNodes.length > 0){
            component.childNodes[0].remove();
        }

        component = document.getElementById("charts");
        component.style.display = "none";

        return false
    }

// checkbox to detect current location
    var checkbox = document.querySelector("input[name=location]");
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            var form = document.getElementById("myForm");
            form.reset();
            
            document.getElementById("street").disabled = true
            document.getElementById("city").disabled = true
            document.getElementById("state").disabled = true

            var result = loadDoc();
            checkbox.value = result;
            this.checked = true;
        }
    });

    function loadDoc() {
        var xhttp = new XMLHttpRequest();
        xhttp.open("GET", "https://ipinfo.io/?token=7b9f26075b4daa", false);
        xhttp.send();
        return xhttp.responseText;
    }

    function getWeatherInfo() {
        component = document.getElementById("cardDetails");
        if(component.childNodes.length > 0){
            return false;
        }
        var locationCheck = document.getElementById('location');
        if(locationCheck.checked){
            var location = JSON.parse(locationCheck.value);
            coord = location['loc']
            lat = coord.split(",")[0];
            lon = coord.split(",")[1];
            city = location['city'];
            country = location['country'];
            postal = location['postal'];
            region = location['region'];
            address = city + ' ' + region + ' ' + country + ' ' + postal;
            display_address = city + ', ' + region + ' ' + postal + ', ' + 'USA'
            
            url = base_url + `fetch_weather_data_using_current_location?lat=${lat}&lon=${lon}&address=${address}&display_address=${display_address}`;
            var req = new XMLHttpRequest();
            req.addEventListener("load", processWeatherDataCurrentLocation);
            req.open("GET", url);
            req.setRequestHeader('Access-Control-Allow-Headers', '*');
            req.setRequestHeader('Content-type', 'application/ecmascript');
            req.setRequestHeader('Access-Control-Allow-Origin', '*');
            req.send();
        }else{
            var street = document.getElementById('street');
            var city = document.getElementById('city');
            var state = document.getElementById('state');
            url = base_url + `fetch_weather_data?street=${street.value}&city=${city.value}&state=${state.value}`;
            var req = new XMLHttpRequest();
            req.addEventListener("load", processWeatherData);
            req.open("GET", url);
            req.setRequestHeader('Access-Control-Allow-Headers', '*');
            req.setRequestHeader('Content-type', 'application/ecmascript');
            req.setRequestHeader('Access-Control-Allow-Origin', '*');
            req.send();
        }
        return false;
    }

    function processWeatherDataCurrentLocation(req){
        var response = JSON.parse(this.responseText);

        errormsg = document.getElementById("errorMsg");
        if(response['error']){
            errormsg.style.display = 'block';
            component = document.getElementById("cardDetails");
            if(component.childNodes.length > 0){
                component.childNodes[0].remove();
            }

            component = document.getElementById("cardDetailsForecast");
            if(component.childNodes.length > 0){
                component.childNodes[0].remove();
            }

            component = document.getElementById("currentWeatherData");
            if(component.childNodes.length > 0){
                component.childNodes[0].remove();
            }

            component = document.getElementById("charts");
            component.style.display = "none";
        
            return;
        }else{
            errormsg.style.display = 'none';
        }
        currentWeatherData(response['current'],response['address'],response['weather_codes']);
        forecastData(response['forecast'],response['weather_codes'],response['hourly']);
    }

    function processWeatherData(req){
        var response = JSON.parse(this.responseText);
        
        errormsg = document.getElementById("errorMsg");
        if(response['error']){
            errormsg.style.display = 'block';
            if(component.childNodes.length > 0){
                component.childNodes[0].remove();
            }

            component = document.getElementById("cardDetailsForecast");
            if(component.childNodes.length > 0){
                component.childNodes[0].remove();
            }

            component = document.getElementById("currentWeatherData");
            if(component.childNodes.length > 0){
                component.childNodes[0].remove();
            }

            component = document.getElementById("charts");
            component.style.display = "none";
            return;
        }else{
            errormsg.style.display = 'none';
        }

        currentWeatherData(response['current'],response['address'],response['weather_codes']);
        forecastData(response['forecast'],response['weather_codes'],response['hourly']);
    }

    function currentWeatherData(current,address,weather_codes){
        var div = document.createElement('div');
        div.innerHTML = `
            <div class="container" style="color: grey;font-size: 20px;">
                    <p style="justify-content: flex-start;">${address}</p>
                    <div style="display: flex;justify-content: space-between;">
                        <div class="current-weather-details" style="align-items: center;width: 30%;">
                            <img src = "../static/Images/${weather_codes[current[0]['values']['weatherCode']][1]}" style="width: 65%; height: 65%;"/>
                            <p style="align-self: flex-start;">${weather_codes[current[0]['values']['weatherCode']][0]}</p>
                        </div>
                        <div style="width: 100%;display: flex;justify-content: center;align-items: center;font-size: 50px;color: grey;">
                            <p style="font-size: 80px;justify-content: flex-end;margin: 0%;margin-right: -30%;margin-bottom: 30px; font-size: 1.6em;font-weight: 300;color: #858585;">
                                ${current[0]['values']['temperature']}
                                <span>&#176;</span>
                            </p>
                        </div>
                    </div>
                    <div style="display: flex;">
                        <div class="current-weather-details">
                            <p>Humidity</p>
                            <img src="https://cdn2.iconfinder.com/data/icons/weather-74/24/weather-16-512.png" alt="Humidity" />
                            <p>${current[0]['values']['humidity']}%</p>
                        </div>
                        <div class="current-weather-details">
                            <p>Pressure</p>
                            <img src="https://cdn2.iconfinder.com/data/icons/weather-74/24/weather-25-512.png" alt="Pressure">
                            <p>${current[0]['values']['pressureSeaLevel']}inHg</p>
                        </div>
                        <div class="current-weather-details">
                            <p>Wind Speed</p>
                            <img src="https://cdn2.iconfinder.com/data/icons/weather-74/24/weather-27-512.png" alt="Wind Speed">
                            <p>${current[0]['values']['windSpeed']}mph</p>
                        </div>
                        <div class="current-weather-details">
                            <p>Visibility</p>
                            <img src="https://cdn2.iconfinder.com/data/icons/weather-74/24/weather-30-512.png" alt="Visibility">
                            <p>${current[0]['values']['visibility']}mi</p>
                        </div>
                        <div class="current-weather-details">
                            <p>Cloud Cover</p>
                            <img src="https://cdn2.iconfinder.com/data/icons/weather-74/24/weather-28-512.png" alt="Cloud Cover">
                            <p>${current[0]['values']['cloudCover']}%</p>
                        </div>
                        <div class="current-weather-details">
                            <p>UV Level</p>
                            <img src="https://cdn2.iconfinder.com/data/icons/weather-74/24/weather-24-512.png" alt="UV Level">
                            <p>${current[0]['values']['uvIndex']}</p>
                        </div>
                    </div>
            </div>
        `;
        document.getElementById('cardDetails').appendChild(div);
    }

    function forecastData(forecast,weather_codes,hourlyData){

        var presentDay = document.getElementById('cardDetails');
        var forecastList = document.getElementById('cardDetailsForecast');
        presentDay.style.display = "block";
        forecastList.style.display = "flex";

        fData = forecast;
        weatherCodes = weather_codes;
        hData = hourlyData;

        var div = document.createElement('div');
        div.innerHTML = `
            <div class="card" style='margin-top: 5%; background-color: rgb(79 110 172);width: 65vw'>
                <div class="container weather-forecast-card">
                    <p style="width:35%">Date</p>
                    <p style="width:25%">Status</p>
                    <p style="width:20%">Temp High</p>
                    <p style="width:20%">Temp Low</p>
                    <p style="width:20%">Wind Speed</p>
                </div>
            </div>`
        for(let i=0;i<forecast.length;i++){
            div.innerHTML += `
                <div class="card" style="margin-top: 0.75%; width: 65vw;" onclick="dayData(${i},fData,weatherCodes,hData)">
                    <div class="container weather-forecast-card">
                        <div style="width:35%">${forecast[i]['Date']}</div>
                        <div style="width:25%">
                            <img src = "../static/Images/${weather_codes[forecast[i]['values']['weatherCode']][1]}" style="width: 50px; height: 50px;"/>
                            <span style="display: flex;flex-direction: column;justify-content: center;margin-left: 10px;">${weather_codes[forecast[i]['values']['weatherCode']][0]}</span>
                        </div>
                        <div style="width:20%">${forecast[i]['values']['temperatureMax']}</div>
                        <div style="width:20%">${forecast[i]['values']['temperatureMin']}</div>
                        <div style="width:20%">${forecast[i]['values']['windSpeed']}</div>
                    </div>
                </div>
            `
        }
        document.getElementById('cardDetailsForecast').appendChild(div);
    }

    function dayData(i,weather,weather_codes,hData){
        data={
            d:weather,
            h:hData
        }

        var presentDay = document.getElementById('cardDetails');
        var forecastList = document.getElementById('cardDetailsForecast');

        presentDay.style.display = "none";
        forecastList.style.display = "none";

        precipitationType = parseInt(weather[i]['values']['precipitationType']);
        console.log(precipitationType);
        type = '';
        if(precipitationType == 0){
            type = 'N/A';
        }else if(precipitationType == 1){
            type = 'Rain';
        }else if(precipitationType == 2){
            type = 'Snow';
        }else if(precipitationType == 3){
            type = 'Freezing Rain';
        }else if(precipitationType == 4){
            type = 'Ice Pellets';
        }


        var div = document.createElement('div');
        div.innerHTML = `
            <div class="daily-weather-card">
            <div class="header">
                <div class="left">
                <div class="date">${weather[i].Date}</div>
                <div class="weather-type">${weather_codes[weather[i]['values']['weatherCode']][0]}</div>
                <div class="min-max">${weather[i]['values']['temperatureMax']}˚F/${weather[i]['values']['temperatureMin']}˚F</div>
                </div>
                <div class="right">
                <img class="weather-type-icon" src="../static/Images/${weather_codes[weather[i]['values']['weatherCode']][1]}" alt="" />
                </div>
            </div>
            <div class="body">
                <table>
                <tr>
                    <td class="key">Precipitation:</td>
                    <td class="value">${type}</td>
                </tr>
                <tr>
                    <td class="key">Chance of Rain:</td>
                    <td class="value">${weather[i]['values']['precipitationProbability']}</td>
                </tr>
                <tr>
                    <td class="key">Wind Speed:</td>
                    <td class="value">${weather[i]['values']['windSpeed']} mph</td>
                </tr>
                <tr>
                    <td class="key">Humidity:</td>
                    <td class="value">${weather[i]['values']['humidity']}%</td>
                </tr>
                <tr>
                    <td class="key">Visibility:</td>
                    <td class="value">${weather[i]['values']['visibility']} mi</td>
                </tr>
                <tr>
                    <td class="key">Sunrise/Sunset:</td>
                    <td class="value">${new Date(weather[i]['values']['sunriseTime']).toLocaleString('en-US',{hour: 'numeric', hour12: true})}/${new Date(weather[i]['values']['sunsetTime']).toLocaleString('en-US',{hour: 'numeric', hour12: true})}</td>
                </tr>
                </table>
            </div>
        </div>

        <br>

        <h3 style="display:flex;justify-content: center;">Weather Charts</h3>
        <span id = "arrow-down" style="display: flex;justify-content: center;font-size: 35px;" onClick="displayCharts(data)">&#8964;</span> 
        <span id = "arrow-up" style="display: none;justify-content: center;font-size: 35px;" onClick="hideCharts()">&#8963;</span> 	
    `
    document.getElementById('currentWeatherData').appendChild(div);
    }

    function hideCharts(){
        aUp = document.getElementById('arrow-up');
        aUp.style.display = "none";

        aDown = document.getElementById('arrow-down');
        aDown.style.display = "flex";

        charts = document.getElementById('charts');
        charts.style.display = "none";
    }

    function displayCharts(data){
    
        aDown = document.getElementById('arrow-down');
        aDown.style.display = "none";

        aUp = document.getElementById('arrow-up');
        aUp.style.display = "flex";

        charts = document.getElementById('charts');
        if(charts.style.display == 'none'){
            charts.style.display = "block";
        }

        d = data['d'];
        h = data['h'];

        arr=[]
        for(var i=0;i<d.length;i++){
            newArr = [];
            newArr.push(Date.parse(d[i].startTime));
            newArr.push(d[i]['values']['temperatureMax']);
            newArr.push(d[i]['values']['temperatureMin']);
            arr.push(newArr);
        }

        arr2=[]
        for(var i=0;i<h.length;i++){
            newArr = [];
            newArr.push(h[i].startTime);
            newArr.push(h[i]['values']['temperature']);
            newArr.push(parseInt(h[i]['values']['humidity']));
            newArr.push(h[i]['values']['windSpeed']);
            newArr.push(h[i]['values']['windDirection']);
            newArr.push(h[i]['values']['pressureSeaLevel']);
            arr2.push(newArr);
        }

        Highcharts.chart('container', {
            chart: {
                type: 'arearange',
                zoomType: 'x',
                scrollablePlotArea: {
                    minWidth: 600,
                    scrollPositionX: 1
                }
            },

            plotOptions: {
                series: {
                    fillColor: {
                        linearGradient: [0, 0, 0, 300],
                        stops: [
                            [0, Highcharts.getOptions().colors[3]],
                            [1, Highcharts.color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                        ]
                    }
                }
            },

            title: {
                text: 'Temperature Ranges (Min, Max)'
            },

            xAxis: {
                type: 'datetime',
                accessibility: {
                    rangeDescription: 'Range: Jan 1st 2017 to Dec 31 2017.'
                }
            },

            yAxis: {
                title: {
                    text: null
                }
            },

            tooltip: {
                crosshairs: true,
                shared: true,
                valueSuffix: '°F',
                xDateFormat: '%A, %b %e'
            },

            legend: {
                enabled: false
            },

            series: [{
                name: 'Temperatures',
                data: arr
            }]

        });

        renderMeteogramChart(arr2);
    }

</script>
</html>